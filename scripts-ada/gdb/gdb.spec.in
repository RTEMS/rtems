#
# spec file for package rtems
# 
# Copyright  (c)  1999  OARCorp, Huntsville, AL
#
# please send bugfixes or comments to joel@OARcorp.com
#

# neededforbuild -- nothing

Vendor:       OAR Corporation
Distribution: Linux
Name:         @Target_alias@-gnat-gdb-collection
Release:      @Release@
License:      GPL/LGPL
Group:        gnatrtems
Provides:     rtems-base-gnat-gdb @Target_alias@-gnat-gdb

Autoreqprov:  on
Packager:     corsepiu@faw.uni-ulm.de and joel@OARcorp.com

Version:      gnat@gnat_version@
Summary:      gdb for target @Target_alias@
Source0:      ftp://ftp.gnu.org/pub/gnu/gdb-@gdb_version@.tar.gz
Source1:	ftp://cs.nyu.edu/pub/gnat/gnat-@gnat_version@-src.tar.gz
Patch0:	      gdb-@gdb_version@-rtems-gnat-@gnat_version@-@gdb_patch_version@.diff
Buildroot:	/tmp

#
# The original sources are not included in the source RPM.
# If we included them, then the source RPMs for each target
# would duplicate MBs of source unnecessarily.  This is 
# a duplication of over 30 MBs of source for each of
# the more than 10 targets it is possible to build.
#
# You can get them yourself from the Internet and copy them to
# your /usr/src/redhat/SOURCES directory ($RPM_SOURCE_DIR).
# Or you can try the ftp options of rpm :-)
#
NoSource:      0
NoSource:      1

%description
RTEMS is an open source operating system for embedded systems.

This is the GNU gdb for RTEMS targetting @Target_alias@.

%package -n rtems-base-gnat-gdb
Summary:      base package for rtems gdb
Group: rtems

%description -n rtems-base-gnat-gdb

RTEMS is an open source operating system for embedded systems.

This is the base for gdb regardless of target CPU.

%package -n @Target_alias@-gnat-gdb
Summary:      rtems gdb for @Target_alias@
Group: rtems
Requires: rtems-base-gnat-gdb

%description -n @Target_alias@-gnat-gdb

RTEMS is an open source operating system for embedded systems.

This is the GNU gdb for RTEMS targetting @Target_alias@.

Authors:
--------
    Joel Sherrill (joel@oarcorp.com)
    ...


%prep
echo RPM_BUILD_ROOT=${RPM_BUILD_ROOT}
# untar the sources inside @Target_alias@-gnat-gdb
%setup -c -n @Target_alias@-gnat-gdb -a 0 -a 1

  cd gdb-@gdb_version@
  patch -p0 <../gnat-@gnat_version@-src/src/gdb-@gdb_version@.gnat.diff

%patch0 -p1

%build
test -d build || mkdir build
  cd build
  ../gdb-@gdb_version@/configure --target=@Target_alias@ \
    --verbose --prefix=/opt/gnatrtems @extra_configure_arguments@

  make CC=gcc CFLAGS="-O2 -g -DRTEMS_TARGET" all
  make info

%install
  cd build
  make prefix=$RPM_BUILD_ROOT/opt/gnatrtems install
  make prefix=$RPM_BUILD_ROOT/opt/gnatrtems install-info

  # gzip info files
  find $RPM_BUILD_ROOT/opt/gnatrtems/info -name "*.info*" | \
    grep -v "\.gz$" | xargs -e gzip -f 2>/dev/null
  # gzip -f $RPM_BUILD_ROOT/opt/gnatrtems/info/*.info 2>/dev/null
  # gzip -f $RPM_BUILD_ROOT/opt/gnatrtems/info/*.info-? 2>/dev/null
  # gzip -f $RPM_BUILD_ROOT/opt/gnatrtems/info/*.info-?? 2>/dev/null

%post
  if test -d $RPM_INSTALL_PREFIX/rtems/info;
  then
    rm -f $RPM_INSTALL_PREFIX/rtems/info/dir
    f=`find $RPM_INSTALL_PREFIX/rtems/info -name '*.info.gz'`
    test -n "$f" && for i in $f; do
      install-info $i $RPM_INSTALL_PREFIX/rtems/info/dir
    done
  fi

%postun
  if test -d $RPM_INSTALL_PREFIX/rtems/info;
  then
    rm -f $RPM_INSTALL_PREFIX/rtems/info/dir
    f=`find $RPM_INSTALL_PREFIX/rtems/info -name '*.info.gz'`
    test -n "$f" && for i in $f; do
      install-info $i $RPM_INSTALL_PREFIX/rtems/info/dir
    done
  fi

%files -n rtems-base-gnat-gdb

%dir /opt/gnatrtems/info
%doc /opt/gnatrtems/info/gdb.info*
%doc /opt/gnatrtems/info/mmalloc.info*
# %doc /opt/gnatrtems/info/readline.info*

%dir /opt/gnatrtems/man
%dir /opt/gnatrtems/man/man1

%dir /opt/gnatrtems/include
# We install libbfd from binutils
# /opt/gnatrtems/include/bfd.h
# /opt/gnatrtems/include/bfdlink.h

%dir /opt/gnatrtems/lib
# We install libbfd from binutils
# /opt/gnatrtems/lib/libbfd*
# We use libiberty from gcc
# /opt/gnatrtems/lib/libiberty*

%files -n @Target_alias@-gnat-gdb
%doc /opt/gnatrtems/man/man1/@Target_alias@-gdb.1

%dir /opt/gnatrtems/bin
/opt/gnatrtems/bin/@Target_alias@-gdb@exe_ext@

